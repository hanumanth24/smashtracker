<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- IMPORTANT for mobile responsiveness -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Badminton Tracker â€“ React + Firebase</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    :root {
      --neon-orange: #ff7a00;
      --bg-dark: #050816;
      --bg-card: rgba(15, 23, 42, 0.9);
      --border-soft: rgba(148, 163, 184, 0.4);
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #1f2933 0, #050816 40%, #020617 80%);
      color: #f9fafb;
    }

    .app-container {
      max-width: 1100px;
      margin: 24px auto 40px;
      padding: 20px 18px 30px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(3, 7, 18, 0.98));
      border-radius: 24px;
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.35),
        0 18px 50px rgba(0, 0, 0, 0.85);
      position: relative;
      overflow: hidden;
    }

    .app-container::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top left, rgba(255, 122, 0, 0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.16), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
      z-index: -1;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.06em;
      color: #fefce8;
      text-transform: uppercase;
      position: relative;
    }

    h1::after {
      content: "";
      position: absolute;
      left: 50%;
      bottom: -8px;
      width: 140px;
      height: 2px;
      transform: translateX(-50%);
      background: linear-gradient(90deg, transparent, var(--neon-orange), transparent);
      box-shadow: 0 0 18px rgba(255, 122, 0, 0.9);
    }

    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 22px;
    }

    h2 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 17px;
      color: #e5e7eb;
      letter-spacing: 0.02em;
    }

    .section-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .top-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.1fr);
      gap: 20px;
      align-items: flex-start;
    }

    .card,
    .match-section,
    .team-card {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(3, 7, 18, 0.98));
      padding: 12px 14px 14px;
      box-shadow:
        0 16px 38px rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(16px);
      transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before,
    .match-section::before,
    .team-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top left, rgba(255, 122, 0, 0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.08), transparent 55%);
      opacity: 0;
      transition: opacity 0.25s ease;
      pointer-events: none;
      z-index: -1;
    }

    .card:hover,
    .match-section:hover,
    .team-card:hover {
      transform: translateY(-3px);
      border-color: rgba(255, 122, 0, 0.8);
      box-shadow:
        0 20px 50px rgba(0, 0, 0, 0.95);
    }

    .card:hover::before,
    .match-section:hover::before,
    .team-card:hover::before {
      opacity: 1;
    }

    .player-form {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .player-form input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 13px;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .player-form input::placeholder {
      color: #6b7280;
    }

    .player-form input:focus {
      border-color: var(--neon-orange);
      box-shadow: 0 0 0 1px rgba(255, 122, 0, 0.6);
      background: rgba(15, 23, 42, 0.95);
    }

    .btn {
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      padding: 7px 16px;
      position: relative;
      overflow: hidden;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #fb923c, var(--neon-orange));
      color: #f9fafb;
      font-weight: 600;
      box-shadow:
        0 0 0 1px rgba(248, 250, 252, 0.1),
        0 0 16px rgba(255, 122, 0, 0.75);
      transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }

    .btn-primary::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        120deg,
        transparent 0%,
        rgba(255, 255, 255, 0.35) 50%,
        transparent 100%
      );
      transform: translateX(-120%);
      transition: transform 0.45s ease-out;
      pointer-events: none;
    }

    .btn-primary:hover::after {
      transform: translateX(120%);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow:
        0 0 20px rgba(255, 122, 0, 0.9);
    }

    .btn-danger {
      background: rgba(127, 29, 29, 0.85);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.6);
      box-shadow: 0 0 12px rgba(127, 29, 29, 0.6);
    }

    .btn-danger:hover {
      background: rgba(185, 28, 28, 0.95);
    }

    .table-shell {
      width: 100%;
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(3, 7, 18, 0.98));
      box-shadow:
        inset 0 0 0 1px rgba(15, 23, 42, 1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
      font-variant-numeric: tabular-nums;
    }

    th,
    td {
      font-size: 12px;
      padding: 7px 8px;
      text-align: center;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      color: #e5e7eb;
      white-space: nowrap;
    }

    thead {
      background: linear-gradient(to right, rgba(31, 41, 55, 0.9), rgba(17, 24, 39, 0.95));
    }

    thead th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.85);
    }

    tbody tr:nth-child(odd) {
      background: rgba(3, 7, 18, 0.9);
    }

    tbody tr:hover {
      background: rgba(30, 64, 175, 0.45);
    }

    .actions button {
      margin: 0 2px;
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
    }

    .actions button:hover {
      transform: translateY(-1px);
      filter: brightness(1.08);
    }

    .actions .win {
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.5);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
    }

    .actions .loss {
      background: rgba(234, 88, 12, 0.18);
      color: #fed7aa;
      border: 1px solid rgba(249, 115, 22, 0.6);
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.4);
    }

    .actions .remove {
      background: rgba(127, 29, 29, 0.9);
      color: #fee2e2;
      border: 1px solid rgba(248, 113, 113, 0.6);
      box-shadow: 0 0 8px rgba(185, 28, 28, 0.5);
    }

    .match-section {
      margin-top: 22px;
      padding: 14px 14px 16px;
    }

    .teams-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }

    .team-card {
      flex: 1;
      min-width: 240px;
      padding: 10px 12px;
    }

    .team-card h3 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #fbbf24;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      font-size: 12px;
      color: #e5e7eb;
      outline: none;
      margin-bottom: 6px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    select option {
      background: #020617;
      color: #e5e7eb;
    }

    select:focus {
      border-color: var(--neon-orange);
      box-shadow: 0 0 0 1px rgba(255, 122, 0, 0.6);
      background: rgba(15, 23, 42, 1);
    }

    label {
      font-size: 11px;
      color: #9ca3af;
      display: block;
      margin-bottom: 2px;
    }

    .muted {
      font-size: 11px;
      color: #9ca3af;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #root {
      min-height: 100vh;
    }

    /* 4D Bottom Notification styles */
    .notification-root {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 9999;
      pointer-events: none;
    }

    .notification-4d {
      pointer-events: auto;
      min-width: 260px;
      max-width: 92vw;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(10, 10, 15, 0.96);
      border: 1px solid rgba(255, 122, 0, 0.85);
      box-shadow:
        0 0 20px rgba(255, 122, 0, 0.8),
        0 0 3px rgba(255, 255, 255, 0.25);
      color: #fefce8;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      animation: notifPop 0.35s cubic-bezier(0.22, 1, 0.36, 1);
      font-size: 12px;
    }

    .notification-4d-message {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .notification-4d-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: rgba(255, 122, 0, 0.15);
      border: 1px solid rgba(255, 122, 0, 0.8);
      box-shadow: 0 0 10px rgba(255, 122, 0, 0.6);
    }

    .notification-4d-close {
      cursor: pointer;
      font-size: 14px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      padding: 0 4px;
      line-height: 1;
      opacity: 0.8;
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .notification-4d-close:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .notif-success {
      border-color: rgba(34, 197, 94, 0.9);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.75);
    }

    .notif-success .notification-4d-icon {
      background: rgba(22, 163, 74, 0.2);
      border-color: rgba(34, 197, 94, 0.9);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.85);
    }

    .notif-error {
      border-color: rgba(248, 113, 113, 0.9);
      box-shadow: 0 0 20px rgba(248, 113, 113, 0.9);
    }

    .notif-error .notification-4d-icon {
      background: rgba(185, 28, 28, 0.25);
      border-color: rgba(248, 113, 113, 0.9);
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.9);
    }

    .notif-info {
      border-color: rgba(59, 130, 246, 0.85);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.9);
    }

    .notif-info .notification-4d-icon {
      background: rgba(37, 99, 235, 0.25);
      border-color: rgba(59, 130, 246, 0.85);
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.9);
    }

    @keyframes notifPop {
      0% {
        transform: translateX(-50%) translateY(40px) scale(0.7);
        opacity: 0;
      }
      60% {
        transform: translateX(-50%) translateY(-4px) scale(1.05);
        opacity: 1;
      }
      100% {
        transform: translateX(-50%) translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* Admin PIN modal */
    .pin-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }

    .pin-modal {
      width: 100%;
      max-width: 320px;
      padding: 16px 16px 14px;
      border-radius: 18px;
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow:
        0 18px 50px rgba(0, 0, 0, 0.95),
        0 0 28px rgba(59, 130, 246, 0.8);
    }

    .pin-modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .pin-modal-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .pin-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.98);
      color: #e5e7eb;
      outline: none;
      font-size: 14px;
      letter-spacing: 0.3em;
      text-align: center;
      margin-bottom: 12px;
    }

    .pin-input:focus {
      border-color: var(--neon-orange);
      box-shadow: 0 0 0 1px rgba(255, 122, 0, 0.65);
    }

    .pin-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .pin-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
    }

    .pin-btn-cancel {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.9);
    }

    .pin-btn-ok {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #f9fafb;
      border: none;
      box-shadow: 0 0 14px rgba(34, 197, 94, 0.8);
    }

    @media (max-width: 900px) {
      .top-layout {
        grid-template-columns: minmax(0, 1fr);
      }

      .app-container {
        margin: 18px 10px 28px;
        padding: 16px 12px 22px;
      }
    }

    @media (max-width: 600px) {
      .app-container {
        margin: 12px 6px 24px;
        padding: 14px 10px 20px;
        border-radius: 18px;
      }

      h1 {
        font-size: 22px;
      }

      .subtitle {
        font-size: 11px;
        padding: 0 4px;
      }

      .player-form {
        flex-direction: column;
      }

      th:nth-child(1),
      td:nth-child(1) {
        display: none;
      }

      th,
      td {
        font-size: 11px;
        padding: 6px 6px;
      }

      .notification-root {
        bottom: 10px;
      }

      .notification-4d {
        padding: 8px 10px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Firebase compat (easier) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCX8k2jee_uB5WYvbK7RdZrnX0-8-wOUuE",
      authDomain: "badminton-tracker-558c1.firebaseapp.com",
      projectId: "badminton-tracker-558c1",
      storageBucket: "badminton-tracker-558c1.firebasestorage.app",
      messagingSenderId: "980136762546",
      appId: "1:980136762546:web:cdd471e086d53e4bd27dab",
      measurementId: "G-FQ82F0MX5E"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const { useState, useEffect, useMemo, useRef, createElement: h } = React;
    const ADMIN_PIN = "2727";

    // ---------- Hook for Firestore collections ----------
    function useCollectionRef(ref) {
      const [docs, setDocs] = useState([]);

      useEffect(() => {
        const unsub = ref.onSnapshot((snap) => {
          const arr = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
          setDocs(arr);
        });
        return unsub;
      }, [ref]);

      return docs;
    }

    function formatTime(ts) {
      try {
        let d;
        if (ts && typeof ts.toDate === "function") {
          d = ts.toDate();
        } else {
          d = new Date(ts || 0);
        }
        return (
          d.toLocaleDateString() +
          " " +
          d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
        );
      } catch {
        return "";
      }
    }

    function getPointsPct(p) {
      const points = p.points || 0;
      const losses = p.losses || 0;
      const total = points + losses;
      if (total === 0) return "0%";
      return ((points / total) * 100).toFixed(1) + "%";
    }

    // ---------- App ----------
    function App() {
      const playersRef = db.collection("players").orderBy("createdAt", "asc");
      const matchesRef = db.collection("matches").orderBy("time", "desc");
      const pendingRef = db.collection("pendingRequests").orderBy("createdAt", "desc");

      const players = useCollectionRef(playersRef);
      const matches = useCollectionRef(matchesRef);
      const pendingRequests = useCollectionRef(pendingRef);

      const [newName, setNewName] = useState("");
      const [historyFilter, setHistoryFilter] = useState("all");

      const [team1, setTeam1] = useState({ p1: "", p2: "" });
      const [team2, setTeam2] = useState({ p1: "", p2: "" });
      const [winnerTeam, setWinnerTeam] = useState("");

      const [notifications, setNotifications] = useState([]);

      // Admin PIN modal state
      const [adminPrompt, setAdminPrompt] = useState({
        open: false,
        actionLabel: "",
        pin: ""
      });
      const adminActionRef = useRef(null);

      function showNotification(message, type = "info", duration = 3000) {
        const id = Date.now().toString() + Math.random().toString(16).slice(2);
        setNotifications((prev) => [...prev, { id, message, type }]);
        if (duration > 0) {
          setTimeout(() => {
            setNotifications((prev) => prev.filter((n) => n.id !== id));
          }, duration);
        }
      }

      function dismissNotification(id) {
        setNotifications((prev) => prev.filter((n) => n.id !== id));
      }

      // Open admin PIN modal with a callback
      function requireAdminPin(actionLabel, callback) {
        adminActionRef.current = callback;
        setAdminPrompt({ open: true, actionLabel, pin: "" });
      }

      function closeAdminModal() {
        adminActionRef.current = null;
        setAdminPrompt((prev) => ({ ...prev, open: false, pin: "" }));
      }

      async function handleAdminPinSubmit(e) {
        e.preventDefault();
        if (adminPrompt.pin !== ADMIN_PIN) {
          showNotification("Wrong PIN", "error");
          return;
        }
        const fn = adminActionRef.current;
        closeAdminModal();
        if (typeof fn === "function") {
          try {
            await fn();
          } catch (err) {
            console.error(err);
            showNotification("Admin action failed.", "error");
          }
        }
      }

      const playerMap = useMemo(() => {
        const map = new Map();
        players.forEach((p) => map.set(p.id, p));
        return map;
      }, [players]);

      function getPlayerName(id) {
        return playerMap.get(id)?.name || "Unknown";
      }

      const sortedPlayers = useMemo(() => {
        const arr = [...players];
        arr.sort((a, b) => {
          if ((b.points || 0) === (a.points || 0)) {
            return (a.name || "").localeCompare(b.name || "");
          }
          return (b.points || 0) - (a.points || 0);
        });
        return arr;
      }, [players]);

      function filteredMatches() {
        if (historyFilter === "all") return matches;
        const now = new Date();
        return matches.filter((m) => {
          let d;
          if (m.time && typeof m.time.toDate === "function") {
            d = m.time.toDate();
          } else {
            d = new Date(m.time || 0);
          }
          if (Number.isNaN(d.getTime())) return true;

          if (historyFilter === "today") {
            return d.toDateString() === now.toDateString();
          }
          if (historyFilter === "week") {
            const diff = now - d;
            return diff >= 0 && diff <= 7 * 24 * 60 * 60 * 1000;
          }
          return true;
        });
      }

      // ---------- FRIEND ACTIONS ----------
      async function requestNewPlayer(e) {
        e.preventDefault();
        const name = newName.trim();
        if (!name) {
          showNotification("Enter a player name.", "error");
          return;
        }
        try {
          await db.collection("pendingRequests").add({
            type: "player",
            name,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
          setNewName("");
          showNotification("Player request submitted. Waiting for admin approval.", "success");
        } catch (err) {
          console.error(err);
          showNotification("Failed to submit player request.", "error");
        }
      }

      async function requestMatch(e) {
        e.preventDefault();
        if (players.length < 4) {
          showNotification("Add at least 4 players first.", "error");
          return;
        }
        const ids = [team1.p1, team1.p2, team2.p1, team2.p2];
        if (ids.some((id) => !id)) {
          showNotification("Select all 4 players.", "error");
          return;
        }
        if (new Set(ids).size !== 4) {
          showNotification("Each position must have a different player.", "error");
          return;
        }
        if (!winnerTeam) {
          showNotification("Select winning team.", "error");
          return;
        }

        const team1Ids = [team1.p1, team1.p2];
        const team2Ids = [team2.p1, team2.p2];

        try {
          await db.collection("pendingRequests").add({
            type: "match",
            team1Ids,
            team2Ids,
            winningTeam: Number(winnerTeam),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          setTeam1({ p1: "", p2: "" });
          setTeam2({ p1: "", p2: "" });
          setWinnerTeam("");
          showNotification("Match request submitted. Waiting for admin approval.", "success");
        } catch (err) {
          console.error(err);
          showNotification("Failed to submit match request.", "error");
        }
      }

      // ---------- ADMIN ACTIONS (all use requireAdminPin) ----------
      function addPoint(id) {
        requireAdminPin("add a point", async () => {
          await db.collection("players").doc(id).update({
            points: firebase.firestore.FieldValue.increment(1),
          });
          showNotification("Point added.", "success");
        });
      }

      function addLoss(id) {
        requireAdminPin("add a loss", async () => {
          await db.collection("players").doc(id).update({
            losses: firebase.firestore.FieldValue.increment(1),
          });
          showNotification("Loss added.", "info");
        });
      }

      function removePlayer(id) {
        requireAdminPin("remove this player", async () => {
          const ok = confirm("Remove this player?");
          if (!ok) return;
          await db.collection("players").doc(id).delete();
          showNotification("Player removed.", "success");
        });
      }

      function resetAll() {
        if (!players.length) return;
        requireAdminPin("reset all points & losses", async () => {
          const ok = confirm("Reset all points and losses?");
          if (!ok) return;
          const batch = db.batch();
          players.forEach((p) => {
            batch.update(db.collection("players").doc(p.id), { points: 0, losses: 0 });
          });
          await batch.commit();
          showNotification("All points and losses reset.", "info");
        });
      }

      function clearHistory() {
        if (!matches.length) return;
        requireAdminPin("clear ALL match history", async () => {
          const ok = confirm("Clear ALL match history?");
          if (!ok) return;
          const batch = db.batch();
          matches.forEach((m) => {
            batch.delete(db.collection("matches").doc(m.id));
          });
          await batch.commit();
          showNotification("Match history cleared.", "info");
        });
      }

      function approveRequest(id) {
        const req = pendingRequests.find((r) => r.id === id);
        if (!req) return;

        requireAdminPin("approve this " + req.type + " request", async () => {
          const reqDocRef = db.collection("pendingRequests").doc(id);

          if (req.type === "player") {
            const name = (req.name || "").trim();
            if (name) {
              await db.collection("players").add({
                name,
                points: 0,
                losses: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
            }
          } else if (req.type === "match") {
            const { team1Ids = [], team2Ids = [], winningTeam } = req;
            let winningIds, losingIds;
            if (winningTeam === 1) {
              winningIds = team1Ids;
              losingIds = team2Ids;
            } else {
              winningIds = team2Ids;
              losingIds = team1Ids;
            }

            const batch = db.batch();
            winningIds.forEach((pid) => {
              batch.update(db.collection("players").doc(pid), {
                points: firebase.firestore.FieldValue.increment(1),
              });
            });
            losingIds.forEach((pid) => {
              batch.update(db.collection("players").doc(pid), {
                losses: firebase.firestore.FieldValue.increment(1),
              });
            });
            await batch.commit();

            await db.collection("matches").add({
              team1Ids,
              team2Ids,
              winningTeam,
              time: firebase.firestore.FieldValue.serverTimestamp(),
            });
          }

          await reqDocRef.delete();
          showNotification("Request approved.", "success");
        });
      }

      async function rejectRequest(id) {
        const req = pendingRequests.find((r) => r.id === id);
        if (!req) return;
        const ok = confirm("Reject this " + req.type + " request?");
        if (!ok) return;
        try {
          await db.collection("pendingRequests").doc(id).delete();
          showNotification("Request rejected.", "info");
        } catch (err) {
          console.error(err);
          showNotification("Failed to reject request.", "error");
        }
      }

      function playerOptions(exclude = []) {
        return players.filter((p) => !exclude.includes(p.id));
      }

      // ---------- UI ----------
      return h(
        React.Fragment,
        null,
        [
          h(
            "div",
            { className: "app-container" },
            [
              h("h1", null, "ðŸ¸ Badminton Group Tracker"),
              h(
                "div",
                { className: "subtitle" },
                "4D Neon Sports Dashboard Â· Friends send requests Â· Admin (PIN 2727) approves Â· Firebase sync across devices."
              ),

              // Top layout
              h(
                "div",
                { className: "top-layout" },
                [
                  // LEFT: players & form
                  h(
                    "div",
                    null,
                    [
                      h("div", { className: "section-label" }, "Players"),
                      h("h2", null, "Scoreboard"),
                      h(
                        "form",
                        { onSubmit: requestNewPlayer, className: "player-form" },
                        [
                          h("input", {
                            type: "text",
                            placeholder: "Request new player name (e.g. Hanu)",
                            value: newName,
                            onChange: (e) => setNewName(e.target.value),
                          }),
                          h(
                            "button",
                            { type: "submit", className: "btn btn-primary" },
                            "Request Player"
                          ),
                        ]
                      ),
                      h(
                        "div",
                        { className: "muted", style: { marginBottom: "6px" } },
                        "Friends request players; admin approves from Pending Requests."
                      ),
                      h(
                        "div",
                        { className: "table-shell" },
                        h(
                          "table",
                          null,
                          [
                            h(
                              "thead",
                              null,
                              h(
                                "tr",
                                null,
                                [
                                  h("th", null, "#"),
                                  h("th", null, "Player"),
                                  h("th", null, "Points"),
                                  h("th", null, "Losses"),
                                  h("th", null, "Win %"),
                                  h("th", null, "Actions"),
                                ]
                              )
                            ),
                            h(
                              "tbody",
                              null,
                              sortedPlayers.length === 0
                                ? h(
                                    "tr",
                                    null,
                                    h(
                                      "td",
                                      { colSpan: 6, className: "muted" },
                                      "No players yet. Ask admin to approve some."
                                    )
                                  )
                                : sortedPlayers.map((p, idx) =>
                                    h(
                                      "tr",
                                      { key: p.id },
                                      [
                                        h("td", null, idx + 1),
                                        h("td", null, p.name),
                                        h("td", null, p.points || 0),
                                        h("td", null, p.losses || 0),
                                        h("td", null, getPointsPct(p)),
                                        h(
                                          "td",
                                          { className: "actions" },
                                          [
                                            h(
                                              "button",
                                              {
                                                className: "win",
                                                onClick: () => addPoint(p.id),
                                              },
                                              "+Point"
                                            ),
                                            h(
                                              "button",
                                              {
                                                className: "loss",
                                                onClick: () => addLoss(p.id),
                                              },
                                              "+Loss"
                                            ),
                                            h(
                                              "button",
                                              {
                                                className: "remove",
                                                onClick: () => removePlayer(p.id),
                                              },
                                              "âœ•"
                                            ),
                                          ]
                                        ),
                                      ]
                                    )
                                  )
                            ),
                          ]
                        )
                      ),
                      h(
                        "div",
                        { style: { marginTop: "8px", textAlign: "right" } },
                        h(
                          "button",
                          { className: "btn btn-danger", onClick: resetAll },
                          "Reset All Points (Admin)"
                        )
                      ),
                    ]
                  ),

                  // RIGHT: summary
                  h(
                    "div",
                    { className: "card" },
                    [
                      h("div", { className: "section-label" }, "Admin Overview"),
                      h("h2", null, "Arena Snapshot"),
                      h(
                        "p",
                        { className: "muted" },
                        `Players: ${players.length} Â· Matches: ${matches.length}`
                      ),
                      h(
                        "p",
                        { className: "muted", style: { marginTop: "4px" } },
                        `Pending requests: ${pendingRequests.length}`
                      ),
                      h(
                        "p",
                        { className: "muted", style: { marginTop: "10px" } },
                        "Tip: Share this URL with your friends. They can request players & matches directly from their phones."
                      ),
                    ]
                  ),
                ]
              ),

              // Match form
              h(
                "div",
                { className: "match-section" },
                [
                  h("div", { className: "section-label" }, "Friends â€“ Group Match"),
                  h("h2", null, "Request Match Result (2 vs 2)"),
                  h(
                    "p",
                    { className: "muted" },
                    "Pick 2 players per team and choose the winner. This becomes a pending request; admin approves it and scores update for everyone."
                  ),
                  h(
                    "form",
                    { onSubmit: requestMatch },
                    [
                      h(
                        "div",
                        { className: "teams-row" },
                        [
                          h(
                            "div",
                            { className: "team-card" },
                            [
                              h("h3", null, "Team 1"),
                              h("label", { htmlFor: "t1p1" }, "Player 1"),
                              h(
                                "select",
                                {
                                  id: "t1p1",
                                  value: team1.p1,
                                  onChange: (e) =>
                                    setTeam1((t) => ({ ...t, p1: e.target.value })),
                                },
                                [
                                  h("option", { value: "" }, "Select"),
                                  ...playerOptions([team1.p2, team2.p1, team2.p2]).map(
                                    (p) =>
                                      h(
                                        "option",
                                        { key: p.id, value: p.id },
                                        p.name
                                      )
                                  ),
                                ]
                              ),
                              h("label", { htmlFor: "t1p2" }, "Player 2"),
                              h(
                                "select",
                                {
                                  id: "t1p2",
                                  value: team1.p2,
                                  onChange: (e) =>
                                    setTeam1((t) => ({ ...t, p2: e.target.value })),
                                },
                                [
                                  h("option", { value: "" }, "Select"),
                                  ...playerOptions([team1.p1, team2.p1, team2.p2]).map(
                                    (p) =>
                                      h(
                                        "option",
                                        { key: p.id, value: p.id },
                                        p.name
                                      )
                                  ),
                                ]
                              ),
                            ]
                          ),
                          h(
                            "div",
                            { className: "team-card" },
                            [
                              h("h3", null, "Team 2"),
                              h("label", { htmlFor: "t2p1" }, "Player 1"),
                              h(
                                "select",
                                {
                                  id: "t2p1",
                                  value: team2.p1,
                                  onChange: (e) =>
                                    setTeam2((t) => ({ ...t, p1: e.target.value })),
                                },
                                [
                                  h("option", { value: "" }, "Select"),
                                  ...playerOptions([team2.p2, team1.p1, team1.p2]).map(
                                    (p) =>
                                      h(
                                        "option",
                                        { key: p.id, value: p.id },
                                        p.name
                                      )
                                  ),
                                ]
                              ),
                              h("label", { htmlFor: "t2p2" }, "Player 2"),
                              h(
                                "select",
                                {
                                  id: "t2p2",
                                  value: team2.p2,
                                  onChange: (e) =>
                                    setTeam2((t) => ({ ...t, p2: e.target.value })),
                                },
                                [
                                  h("option", { value: "" }, "Select"),
                                  ...playerOptions([team2.p1, team1.p1, team1.p2]).map(
                                    (p) =>
                                      h(
                                        "option",
                                        { key: p.id, value: p.id },
                                        p.name
                                      )
                                  ),
                                ]
                              ),
                            ]
                          ),
                        ]
                      ),
                      h(
                        "div",
                        { style: { display: "flex", gap: "10px", alignItems: "center", flexWrap: "wrap" } },
                        [
                          h(
                            "div",
                            null,
                            [
                              h("label", { htmlFor: "winner-team" }, "Winning team"),
                              h(
                                "select",
                                {
                                  id: "winner-team",
                                  value: winnerTeam,
                                  onChange: (e) => setWinnerTeam(e.target.value),
                                },
                                [
                                  h("option", { value: "" }, "Select winner"),
                                  h("option", { value: "1" }, "Team 1"),
                                  h("option", { value: "2" }, "Team 2"),
                                ]
                              ),
                            ]
                          ),
                          h(
                            "button",
                            { type: "submit", className: "btn btn-primary" },
                            "Request Match"
                          ),
                        ]
                      ),
                    ]
                  ),
                ]
              ),

              // Pending
              h(
                "div",
                { style: { marginTop: "22px" } },
                [
                  h("div", { className: "section-label" }, "Admin â€“ Pending"),
                  h("h2", null, "Pending Requests"),
                  h(
                    "div",
                    { className: "table-shell" },
                    h(
                      "table",
                      null,
                      [
                        h(
                          "thead",
                          null,
                          h(
                            "tr",
                            null,
                            [
                              h("th", null, "#"),
                              h("th", null, "Type"),
                              h("th", null, "Details"),
                              h("th", null, "Submitted"),
                              h("th", null, "Actions"),
                            ]
                          )
                        ),
                        h(
                          "tbody",
                          null,
                          pendingRequests.length === 0
                            ? h(
                                "tr",
                                null,
                                h(
                                  "td",
                                  { colSpan: 5, className: "muted" },
                                  "No pending requests."
                                )
                              )
                            : pendingRequests.map((req, idx) => {
                                let typeLabel = "";
                                let details = "";
                                if (req.type === "player") {
                                  typeLabel = "New Player";
                                  details = `Name: ${req.name}`;
                                } else if (req.type === "match") {
                                  const t1 = (req.team1Ids || [])
                                    .map((id) => getPlayerName(id))
                                    .join(" & ");
                                  const t2 = (req.team2Ids || [])
                                    .map((id) => getPlayerName(id))
                                    .join(" & ");
                                  const winner =
                                    req.winningTeam === 1 ? "Team 1" : "Team 2";
                                  details = `T1: ${t1} | T2: ${t2} | Winner: ${winner}`;
                                }
                                return h(
                                  "tr",
                                  { key: req.id },
                                  [
                                    h("td", null, idx + 1),
                                    h("td", null, typeLabel),
                                    h("td", { style: { textAlign: "left", fontSize: "12px" } }, details),
                                    h("td", null, formatTime(req.createdAt)),
                                    h(
                                      "td",
                                      null,
                                      [
                                        h(
                                          "button",
                                          {
                                            className: "btn btn-primary",
                                            style: { padding: "4px 10px", marginRight: "4px" },
                                            onClick: () => approveRequest(req.id),
                                          },
                                          "Approve"
                                        ),
                                        h(
                                          "button",
                                          {
                                            className: "btn btn-danger",
                                            style: { padding: "4px 10px" },
                                            onClick: () => rejectRequest(req.id),
                                          },
                                          "Reject"
                                        ),
                                      ]
                                    ),
                                  ]
                                );
                              })
                        ),
                      ]
                    )
                  ),
                ]
              ),

              // History
              h(
                "div",
                { style: { marginTop: "22px" } },
                [
                  h("div", { className: "section-label" }, "History"),
                  h(
                    "div",
                    { className: "history-header" },
                    [
                      h("h2", null, "Match History"),
                      h(
                        "div",
                        { style: { display: "flex", gap: "8px", alignItems: "center", flexWrap: "wrap" } },
                        [
                          h("span", { className: "muted" }, "Filter:"),
                          h(
                            "select",
                            {
                              value: historyFilter,
                              onChange: (e) => setHistoryFilter(e.target.value),
                              id: "history-filter",
                            },
                            [
                              h("option", { value: "all" }, "All"),
                              h("option", { value: "today" }, "Today"),
                              h("option", { value: "week" }, "Last 7 days"),
                            ]
                          ),
                          h(
                            "button",
                            { className: "btn btn-danger", onClick: clearHistory },
                            "Clear History (Admin)"
                          ),
                        ]
                      ),
                    ]
                  ),
                  h(
                    "div",
                    { className: "table-shell" },
                    h(
                      "table",
                      null,
                      [
                        h(
                          "thead",
                          null,
                          h(
                            "tr",
                            null,
                            [
                              h("th", null, "#"),
                              h("th", null, "Team 1"),
                              h("th", null, "Team 2"),
                              h("th", null, "Winner"),
                              h("th", null, "Time"),
                            ]
                          )
                        ),
                        h(
                          "tbody",
                          null,
                          filteredMatches().length === 0
                            ? h(
                                "tr",
                                null,
                                h(
                                  "td",
                                  { colSpan: 5, className: "muted" },
                                  "No matches yet."
                                )
                              )
                            : filteredMatches().map((m, idx) => {
                                const t1Names = (m.team1Ids || [])
                                  .map((id) => getPlayerName(id))
                                  .join(" & ");
                                const t2Names = (m.team2Ids || [])
                                  .map((id) => getPlayerName(id))
                                  .join(" & ");
                                const winnerNames =
                                  m.winningTeam === 1 ? t1Names : t2Names;
                                return h(
                                  "tr",
                                  { key: m.id },
                                  [
                                    h("td", null, idx + 1),
                                    h("td", null, t1Names),
                                    h("td", null, t2Names),
                                    h("td", null, winnerNames),
                                    h("td", null, formatTime(m.time)),
                                  ]
                                );
                              })
                        ),
                      ]
                    )
                  ),
                ]
              ),
            ]
          ),

          // Admin PIN modal
          adminPrompt.open &&
            h(
              "div",
              { className: "pin-backdrop" },
              h(
                "form",
                { className: "pin-modal", onSubmit: handleAdminPinSubmit },
                [
                  h("div", { className: "pin-modal-title" }, "Admin PIN"),
                  h(
                    "div",
                    { className: "pin-modal-sub" },
                    "Enter PIN to " + adminPrompt.actionLabel + "."
                  ),
                  h("input", {
                    className: "pin-input",
                    type: "password",
                    maxLength: 6,
                    autoFocus: true,
                    value: adminPrompt.pin,
                    onChange: (e) =>
                      setAdminPrompt((prev) => ({ ...prev, pin: e.target.value })),
                  }),
                  h(
                    "div",
                    { className: "pin-modal-actions" },
                    [
                      h(
                        "button",
                        {
                          type: "button",
                          className: "pin-btn pin-btn-cancel",
                          onClick: closeAdminModal,
                        },
                        "Cancel"
                      ),
                      h(
                        "button",
                        { type: "submit", className: "pin-btn pin-btn-ok" },
                        "Confirm"
                      ),
                    ]
                  ),
                ]
              )
            ),

          // 4D bottom notifications
          h(
            "div",
            { className: "notification-root" },
            notifications.map((n) =>
              h(
                "div",
                {
                  key: n.id,
                  className:
                    "notification-4d " +
                    (n.type === "success"
                      ? "notif-success"
                      : n.type === "error"
                      ? "notif-error"
                      : "notif-info"),
                },
                [
                  h(
                    "div",
                    { className: "notification-4d-message" },
                    [
                      h(
                        "span",
                        { className: "notification-4d-icon" },
                        n.type === "success" ? "âœ“" : n.type === "error" ? "!" : "i"
                      ),
                      h("span", null, n.message),
                    ]
                  ),
                  h(
                    "button",
                    {
                      className: "notification-4d-close",
                      onClick: () => dismissNotification(n.id),
                    },
                    "Ã—"
                  ),
                ]
              )
            )
          ),
        ]
      );
    }

    // Bootstrap React
    (function () {
      const container = document.getElementById("root");
      if (!container) {
        console.error("No #root element found in DOM.");
        return;
      }
      const root = ReactDOM.createRoot(container);
      root.render(h(App));
    })();
  </script>
</body>
</html>
