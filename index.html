<script type="module">
  import React from "https://esm.sh/react@18.2.0";
  import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    addDoc,
    updateDoc,
    deleteDoc,
    onSnapshot,
    query,
    orderBy,
    serverTimestamp,
    increment
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ---------- Firebase config (your project) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCX8k2jee_uB5WYvbK7RdZrnX0-8-wOUuE",
    authDomain: "badminton-tracker-558c1.firebaseapp.com",
    projectId: "badminton-tracker-558c1",
    storageBucket: "badminton-tracker-558c1.firebasestorage.app",
    messagingSenderId: "980136762546",
    appId: "1:980136762546:web:cdd471e086d53e4bd27dab",
    measurementId: "G-FQ82F0MX5E"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ADMIN_PIN = "2727";
  const h = React.createElement;

  // ---------- Small hooks ----------
  function useCollection(q) {
    const [docs, setDocs] = React.useState([]);

    React.useEffect(() => {
      const unsub = onSnapshot(q, (snap) => {
        const arr = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        setDocs(arr);
      });
      return unsub;
    }, [q]);

    return docs;
  }

  // ---------- Helpers ----------
  function askAdmin(action) {
    const entered = prompt("Admin PIN required to " + action + ". Enter PIN:");
    if (entered === null) return false;
    if (entered === ADMIN_PIN) return true;
    alert("Wrong PIN");
    return false;
  }

  function formatTime(tsOrIso) {
    try {
      let d;
      if (tsOrIso && typeof tsOrIso.toDate === "function") {
        d = tsOrIso.toDate();
      } else {
        d = new Date(tsOrIso || 0);
      }
      return (
        d.toLocaleDateString() +
        " " +
        d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
      );
    } catch {
      return "";
    }
  }

  function getPointsPct(p) {
    const points = p.points || 0;
    const losses = p.losses || 0;
    const total = points + losses;
    if (total === 0) return "0%";
    return ((points / total) * 100).toFixed(1) + "%";
  }

  // ---------- App component ----------
  function App() {
    const players = useCollection(
      query(collection(db, "players"), orderBy("createdAt", "asc"))
    );
    const matches = useCollection(
      query(collection(db, "matches"), orderBy("time", "desc"))
    );
    const pendingRequests = useCollection(
      query(collection(db, "pendingRequests"), orderBy("createdAt", "desc"))
    );

    const [newName, setNewName] = React.useState("");
    const [historyFilter, setHistoryFilter] = React.useState("all");

    const [team1, setTeam1] = React.useState({ p1: "", p2: "" });
    const [team2, setTeam2] = React.useState({ p1: "", p2: "" });
    const [winnerTeam, setWinnerTeam] = React.useState("");

    const playerMap = React.useMemo(() => {
      const map = new Map();
      players.forEach((p) => map.set(p.id, p));
      return map;
    }, [players]);

    function getPlayerName(id) {
      return playerMap.get(id)?.name || "Unknown";
    }

    const sortedPlayers = React.useMemo(() => {
      const arr = [...players];
      arr.sort((a, b) => {
        if ((b.points || 0) === (a.points || 0)) {
          return (a.name || "").localeCompare(b.name || "");
        }
        return (b.points || 0) - (a.points || 0);
      });
      return arr;
    }, [players]);

    function filteredMatches() {
      if (historyFilter === "all") return matches;
      const now = new Date();
      return matches.filter((m) => {
        let d;
        if (m.time && typeof m.time.toDate === "function") {
          d = m.time.toDate();
        } else {
          d = new Date(m.time || 0);
        }
        if (Number.isNaN(d.getTime())) return true;

        if (historyFilter === "today") {
          return d.toDateString() === now.toDateString();
        }
        if (historyFilter === "week") {
          const diff = now - d;
          return diff >= 0 && diff <= 7 * 24 * 60 * 60 * 1000;
        }
        return true;
      });
    }

    // ---------- Firestore refs ----------
    const playersCol = collection(db, "players");
    const matchesCol = collection(db, "matches");
    const pendingCol = collection(db, "pendingRequests");

    // ---------- FRIEND ACTIONS (create pending) ----------
    async function requestNewPlayer(e) {
      e.preventDefault();
      const name = newName.trim();
      if (!name) return;
      await addDoc(pendingCol, {
        type: "player",
        name,
        createdAt: serverTimestamp(),
      });
      setNewName("");
      alert("Player request submitted. Admin will approve it.");
    }

    async function requestMatch(e) {
      e.preventDefault();
      if (players.length < 4) {
        alert("Add at least 4 players first.");
        return;
      }
      const ids = [team1.p1, team1.p2, team2.p1, team2.p2];
      if (ids.some((id) => !id)) {
        alert("Select all 4 players.");
        return;
      }
      if (new Set(ids).size !== 4) {
        alert("Each position must have a different player.");
        return;
      }
      if (!winnerTeam) {
        alert("Select winning team.");
        return;
      }

      const team1Ids = [team1.p1, team1.p2];
      const team2Ids = [team2.p1, team2.p2];

      await addDoc(pendingCol, {
        type: "match",
        team1Ids,
        team2Ids,
        winningTeam: Number(winnerTeam),
        createdAt: serverTimestamp(),
      });

      setTeam1({ p1: "", p2: "" });
      setTeam2({ p1: "", p2: "" });
      setWinnerTeam("");
      alert("Match request submitted. Admin will approve it.");
    }

    // ---------- ADMIN ACTIONS ----------
    async function addPoint(id) {
      if (!askAdmin("add a point")) return;
      await updateDoc(doc(db, "players", id), { points: increment(1) });
    }

    async function addLoss(id) {
      if (!askAdmin("add a loss")) return;
      await updateDoc(doc(db, "players", id), { losses: increment(1) });
    }

    async function removePlayer(id) {
      if (!askAdmin("remove this player")) return;
      await deleteDoc(doc(db, "players", id));
    }

    async function resetAll() {
      if (!players.length) return;
      if (!askAdmin("reset all points & losses")) return;
      await Promise.all(
        players.map((p) =>
          updateDoc(doc(db, "players", p.id), { points: 0, losses: 0 })
        )
      );
    }

    async function clearHistory() {
      if (!matches.length) return;
      if (!askAdmin("clear ALL match history")) return;
      await Promise.all(
        matches.map((m) => deleteDoc(doc(db, "matches", m.id)))
      );
    }

    async function approveRequest(id) {
      const req = pendingRequests.find((r) => r.id === id);
      if (!req) return;
      if (!askAdmin("approve this " + req.type + " request")) return;

      if (req.type === "player") {
        const name = (req.name || "").trim();
        if (name) {
          await addDoc(playersCol, {
            name,
            points: 0,
            losses: 0,
            createdAt: serverTimestamp(),
          });
        }
      } else if (req.type === "match") {
        const { team1Ids, team2Ids, winningTeam } = req;
        let winningIds, losingIds;
        if (winningTeam === 1) {
          winningIds = team1Ids;
          losingIds = team2Ids;
        } else {
          winningIds = team2Ids;
          losingIds = team1Ids;
        }

        await Promise.all(
          winningIds.map((pid) =>
            updateDoc(doc(db, "players", pid), { points: increment(1) })
          )
        );
        await Promise.all(
          losingIds.map((pid) =>
            updateDoc(doc(db, "players", pid), { losses: increment(1) })
          )
        );

        await addDoc(matchesCol, {
          team1Ids,
          team2Ids,
          winningTeam,
          time: serverTimestamp(),
        });
      }

      await deleteDoc(doc(db, "pendingRequests", id));
    }

    async function rejectRequest(id) {
      const req = pendingRequests.find((r) => r.id === id);
      if (!req) return;
      const ok = confirm("Reject this " + req.type + " request?");
      if (!ok) return;
      await deleteDoc(doc(db, "pendingRequests", id));
    }

    // ---------- options for selects ----------
    function playerOptions(exclude = []) {
      return players.filter((p) => !exclude.includes(p.id));
    }

    // ---------- UI ----------
    return h(
      "div",
      { className: "app-container" },
      [
        h("h1", null, "ðŸ¸ Badminton Group Tracker (React + Admin)"),
        h(
          "div",
          { className: "subtitle" },
          "Friends send requests; admin (PIN 2727) approves. Firebase keeps everything in sync."
        ),

        // Top layout
        h(
          "div",
          { className: "top-layout" },
          [
            // LEFT: players & form (friends: request new player)
            h(
              "div",
              null,
              [
                h("div", { className: "section-label" }, "Players"),
                h("h2", null, "Scoreboard"),
                h(
                  "form",
                  { onSubmit: requestNewPlayer, className: "player-form" },
                  [
                    h("input", {
                      type: "text",
                      placeholder: "Request new player name (e.g. Hanu)",
                      value: newName,
                      onChange: (e) => setNewName(e.target.value),
                    }),
                    h(
                      "button",
                      { type: "submit", className: "btn btn-primary" },
                      "Request Player"
                    ),
                  ]
                ),
                h(
                  "div",
                  { className: "muted", style: { marginBottom: "6px" } },
                  "Admin will approve from Pending Requests."
                ),
                h(
                  "table",
                  null,
                  [
                    h(
                      "thead",
                      null,
                      h(
                        "tr",
                        null,
                        [
                          h("th", null, "#"),
                          h("th", null, "Player"),
                          h("th", null, "Points"),
                          h("th", null, "Losses"),
                          h("th", null, "Points %"),
                          h("th", null, "Actions (Admin)"),
                        ]
                      )
                    ),
                    h(
                      "tbody",
                      null,
                      sortedPlayers.length === 0
                        ? h(
                            "tr",
                            null,
                            h(
                              "td",
                              { colSpan: 6, className: "muted" },
                              "No players yet. Ask admin to approve some."
                            )
                          )
                        : sortedPlayers.map((p, idx) =>
                            h(
                              "tr",
                              { key: p.id },
                              [
                                h("td", null, idx + 1),
                                h("td", null, p.name),
                                h("td", null, p.points || 0),
                                h("td", null, p.losses || 0),
                                h("td", null, getPointsPct(p)),
                                h(
                                  "td",
                                  { className: "actions" },
                                  [
                                    h(
                                      "button",
                                      {
                                        className: "win",
                                        onClick: () => addPoint(p.id),
                                      },
                                      "+Point"
                                    ),
                                    h(
                                      "button",
                                      {
                                        className: "loss",
                                        onClick: () => addLoss(p.id),
                                      },
                                      "+Loss"
                                    ),
                                    h(
                                      "button",
                                      {
                                        className: "remove",
                                        onClick: () => removePlayer(p.id),
                                      },
                                      "âœ•"
                                    ),
                                  ]
                                ),
                              ]
                            )
                          )
                    ),
                  ]
                ),
                h(
                  "div",
                  { style: { marginTop: "8px", textAlign: "right" } },
                  h(
                    "button",
                    { className: "btn btn-danger", onClick: resetAll },
                    "Reset All Points (Admin)"
                  )
                ),
              ]
            ),

            // RIGHT: quick stats + pending
            h(
              "div",
              { className: "card" },
              [
                h("div", { className: "section-label" }, "Admin Overview"),
                h("h2", null, "Summary"),
                h(
                  "p",
                  { className: "muted" },
                  `Players: ${players.length} Â· Matches: ${matches.length}`
                ),
                h(
                  "p",
                  { className: "muted", style: { marginTop: "4px" } },
                  `Pending requests: ${pendingRequests.length}`
                ),
              ]
            ),
          ]
        ),

        // Match form (friends create pending)
        h(
          "div",
          { className: "match-section" },
          [
            h("div", { className: "section-label" }, "Friends â€“ Group Match"),
            h("h2", null, "Request Match Result (2 vs 2)"),
            h(
              "p",
              { className: "muted" },
              "Pick 2 players per team and choose the winner. This becomes a pending request; admin approves it."
            ),
            h(
              "form",
              { onSubmit: requestMatch },
              [
                h(
                  "div",
                  { className: "teams-row" },
                  [
                    h(
                      "div",
                      { className: "team-card" },
                      [
                        h("h3", null, "Team 1"),
                        h("label", { htmlFor: "t1p1" }, "Player 1"),
                        h(
                          "select",
                          {
                            id: "t1p1",
                            value: team1.p1,
                            onChange: (e) =>
                              setTeam1((t) => ({ ...t, p1: e.target.value })),
                          },
                          [
                            h("option", { value: "" }, "Select"),
                            ...playerOptions([team1.p2, team2.p1, team2.p2]).map(
                              (p) =>
                                h(
                                  "option",
                                  { key: p.id, value: p.id },
                                  p.name
                                )
                            ),
                          ]
                        ),
                        h("label", { htmlFor: "t1p2" }, "Player 2"),
                        h(
                          "select",
                          {
                            id: "t1p2",
                            value: team1.p2,
                            onChange: (e) =>
                              setTeam1((t) => ({ ...t, p2: e.target.value })),
                          },
                          [
                            h("option", { value: "" }, "Select"),
                            ...playerOptions([team1.p1, team2.p1, team2.p2]).map(
                              (p) =>
                                h(
                                  "option",
                                  { key: p.id, value: p.id },
                                  p.name
                                )
                            ),
                          ]
                        ),
                      ]
                    ),
                    h(
                      "div",
                      { className: "team-card" },
                      [
                        h("h3", null, "Team 2"),
                        h("label", { htmlFor: "t2p1" }, "Player 1"),
                        h(
                          "select",
                          {
                            id: "t2p1",
                            value: team2.p1,
                            onChange: (e) =>
                              setTeam2((t) => ({ ...t, p1: e.target.value })),
                          },
                          [
                            h("option", { value: "" }, "Select"),
                            ...playerOptions([team2.p2, team1.p1, team1.p2]).map(
                              (p) =>
                                h(
                                  "option",
                                  { key: p.id, value: p.id },
                                  p.name
                                )
                            ),
                          ]
                        ),
                        h("label", { htmlFor: "t2p2" }, "Player 2"),
                        h(
                          "select",
                          {
                            id: "t2p2",
                            value: team2.p2,
                            onChange: (e) =>
                              setTeam2((t) => ({ ...t, p2: e.target.value })),
                          },
                          [
                            h("option", { value: "" }, "Select"),
                            ...playerOptions([team2.p1, team1.p1, team1.p2]).map(
                              (p) =>
                                h(
                                  "option",
                                  { key: p.id, value: p.id },
                                  p.name
                                )
                            ),
                          ]
                        ),
                      ]
                    ),
                  ]
                ),
                h(
                  "div",
                  { style: { display: "flex", gap: "10px", alignItems: "center", flexWrap: "wrap" } },
                  [
                    h(
                      "div",
                      null,
                      [
                        h("label", { htmlFor: "winner-team" }, "Winning team"),
                        h(
                          "select",
                          {
                            id: "winner-team",
                            value: winnerTeam,
                            onChange: (e) => setWinnerTeam(e.target.value),
                          },
                          [
                            h("option", { value: "" }, "Select winner"),
                            h("option", { value: "1" }, "Team 1"),
                            h("option", { value: "2" }, "Team 2"),
                          ]
                        ),
                      ]
                    ),
                    h(
                      "button",
                      { type: "submit", className: "btn btn-primary" },
                      "Request Match"
                    ),
                  ]
                ),
              ]
            ),
          ]
        ),

        // Pending requests (Admin)
        h(
          "div",
          { style: { marginTop: "22px" } },
          [
            h("div", { className: "section-label" }, "Admin â€“ Pending"),
            h("h2", null, "Pending Requests"),
            h(
              "table",
              null,
              [
                h(
                  "thead",
                  null,
                  h(
                    "tr",
                    null,
                    [
                      h("th", null, "#"),
                      h("th", null, "Type"),
                      h("th", null, "Details"),
                      h("th", null, "Submitted"),
                      h("th", null, "Actions (PIN)"),
                    ]
                  )
                ),
                h(
                  "tbody",
                  null,
                  pendingRequests.length === 0
                    ? h(
                        "tr",
                        null,
                        h(
                          "td",
                          { colSpan: 5, className: "muted" },
                          "No pending requests."
                        )
                      )
                    : pendingRequests.map((req, idx) => {
                        let typeLabel = "";
                        let details = "";
                        if (req.type === "player") {
                          typeLabel = "New Player";
                          details = `Name: ${req.name}`;
                        } else if (req.type === "match") {
                          const t1 = (req.team1Ids || [])
                            .map((id) => getPlayerName(id))
                            .join(" & ");
                          const t2 = (req.team2Ids || [])
                            .map((id) => getPlayerName(id))
                            .join(" & ");
                          const winner =
                            req.winningTeam === 1 ? "Team 1" : "Team 2";
                          details = `T1: ${t1} | T2: ${t2} | Winner: ${winner}`;
                        }
                        return h(
                          "tr",
                          { key: req.id },
                          [
                            h("td", null, idx + 1),
                            h("td", null, typeLabel),
                            h("td", { style: { textAlign: "left", fontSize: "12px" } }, details),
                            h("td", null, formatTime(req.createdAt)),
                            h(
                              "td",
                              null,
                              [
                                h(
                                  "button",
                                  {
                                    className: "btn btn-primary",
                                    style: { padding: "4px 10px", marginRight: "4px" },
                                    onClick: () => approveRequest(req.id),
                                  },
                                  "Approve"
                                ),
                                h(
                                  "button",
                                  {
                                    className: "btn btn-danger",
                                    style: { padding: "4px 10px" },
                                    onClick: () => rejectRequest(req.id),
                                  },
                                  "Reject"
                                ),
                              ]
                            ),
                          ]
                        );
                      })
                ),
              ]
            ),
          ]
        ),

        // History
        h(
          "div",
          { style: { marginTop: "22px" } },
          [
            h("div", { className: "section-label" }, "History"),
            h(
              "div",
              { className: "history-header" },
              [
                h("h2", null, "Match History"),
                h(
                  "div",
                  { style: { display: "flex", gap: "8px", alignItems: "center", flexWrap: "wrap" } },
                  [
                    h("span", { className: "muted" }, "Filter:"),
                    h(
                      "select",
                      {
                        value: historyFilter,
                        onChange: (e) => setHistoryFilter(e.target.value),
                        id: "history-filter",
                      },
                      [
                        h("option", { value: "all" }, "All"),
                        h("option", { value: "today" }, "Today"),
                        h("option", { value: "week" }, "Last 7 days"),
                      ]
                    ),
                    h(
                      "button",
                      { className: "btn btn-danger", onClick: clearHistory },
                      "Clear History (Admin)"
                    ),
                  ]
                ),
              ]
            ),
            h(
              "table",
              null,
              [
                h(
                  "thead",
                  null,
                  h(
                    "tr",
                    null,
                    [
                      h("th", null, "#"),
                      h("th", null, "Team 1"),
                      h("th", null, "Team 2"),
                      h("th", null, "Winner"),
                      h("th", null, "Time"),
                    ]
                  )
                ),
                h(
                  "tbody",
                  null,
                  filteredMatches().length === 0
                    ? h(
                        "tr",
                        null,
                        h(
                          "td",
                          { colSpan: 5, className: "muted" },
                          "No matches yet."
                        )
                      )
                    : filteredMatches().map((m, idx) => {
                        const t1Names = (m.team1Ids || [])
                          .map((id) => getPlayerName(id))
                          .join(" & ");
                        const t2Names = (m.team2Ids || [])
                          .map((id) => getPlayerName(id))
                          .join(" & ");
                        const winnerNames =
                          m.winningTeam === 1 ? t1Names : t2Names;
                        return h(
                          "tr",
                          { key: m.id },
                          [
                            h("td", null, idx + 1),
                            h("td", null, t1Names),
                            h("td", null, t2Names),
                            h("td", null, winnerNames),
                            h("td", null, formatTime(m.time)),
                          ]
                        );
                      })
                ),
              ]
            ),
          ]
        ),
      ]
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(h(App));
</script>
